{% extends 'quote_view.html' %}
{% load staticfiles %}
{% load quotes %}

{% block title %}{{ quote }}{% endblock %}

{% block content %}
  <div class="container">
    {% include "single_quote.html" with with_link=False %}
    <div class="row">
      <div class="col-md-12">
        <p class="alert alert-info hidden" id="likes_list"><strong>Likes:</strong> <span id="likers"></span></p>
      </div>
    </div>
    {% if user.is_authenticated %}
      <div class="row" style="margin-bottom: 1em;">
        <div class="col-md-12">
          <form class="form" role="form" id="new_comment_form" action="{% url 'quote:comment-create' pk=quote.pk %}" data-source="#new_comment_text" method="POST">
            {% csrf_token %}
            <div class="form-group">
              <textarea class="form-control" id="new_comment_text" name="text" placeholder="Say something"></textarea>
            </div>
            <input class="btn btn-primary pull-right flip" type="submit" value="Comment"\>
          </form>
        </div>
      </div>
    {% endif %}
    <div class="row">
      <div class="col-md-12">
        {% comments %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script type="text/javascript">
    function updateLikes(likers) {
      if (likers.length) {
        $.get({
          url: "{% url 'quote:likers' pk=quote.pk %}",
          data: {"likers": likers },
          success: function(response) {
            $("#likes_list > #likers").html(response);
            $("#likes_list").removeClass("hidden");
          }});
      }
      else {
        $("#likes_list").addClass("hidden");
      }
    }

    $(function () {
      $.get({
        "url": "{% url 'quote:like' pk=quote.pk %}",
        success: function(response) {
          updateLikes(response.likers);
        }});
    });

    $(document).ready(function() {
      $("button.btn-like, button.btn-unlike").bind(
        "likes_updated",
        function(event, likers) { updateLikes(likers); });
    });
  </script>
  <script type="text/javascript">
    $("#new_comment_form").submit(addComment);
  </script>
{% endblock %}
